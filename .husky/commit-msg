# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
NC='\033[0m' # No Color

# Function to print colored output
print_info() {
  echo "${BLUE}ℹ${NC} $1"
}

print_success() {
  echo "${GREEN}✅${NC} $1"
}

print_error() {
  echo "${RED}❌${NC} $1" >&2
}

print_warning() {
  echo "${YELLOW}⚠️${NC} $1"
}

# Get the commit message file path
commit_msg_file="$1"

# Read commit message
commit_msg=$(cat "$commit_msg_file")

# Get the first line (subject line)
subject_line=$(echo "$commit_msg" | head -n 1)

# Skip validation for merge commits and revert commits
if echo "$subject_line" | grep -qE "^(Merge|Revert)"; then
  print_info "Merge/Revert commit detected, skipping validation"
  exit 0
fi

# Valid commit types
valid_types="feat|fix|docs|style|refactor|perf|test|chore|build|ci|revert|deps"

# Check if commit message follows conventional commits format
# Format: type(scope): subject
# - type is required and must be one of the valid types
# - scope is optional
# - subject is required and must be at least 1 character
if ! echo "$subject_line" | grep -qE "^($valid_types)(\(.+\))?: .{1,}"; then
  print_error "Invalid commit message format!"
  echo ""
  print_info "Commit message must follow Conventional Commits format:"
  echo "  ${CYAN}<type>(<scope>): <subject>${NC}"
  echo ""
  print_info "Valid types:"
  echo "  ${CYAN}feat${NC}     - New feature"
  echo "  ${CYAN}fix${NC}      - Bug fix"
  echo "  ${CYAN}docs${NC}     - Documentation changes"
  echo "  ${CYAN}style${NC}    - Code style changes (formatting)"
  echo "  ${CYAN}refactor${NC} - Code refactoring"
  echo "  ${CYAN}perf${NC}     - Performance improvements"
  echo "  ${CYAN}test${NC}     - Adding or updating tests"
  echo "  ${CYAN}chore${NC}    - Maintenance tasks"
  echo "  ${CYAN}build${NC}    - Build system changes"
  echo "  ${CYAN}ci${NC}       - CI/CD changes"
  echo "  ${CYAN}deps${NC}     - Dependency updates"
  echo "  ${CYAN}revert${NC}   - Revert previous commit"
  echo ""
  print_info "Examples:"
  echo "  ${CYAN}feat: add new blog post${NC}"
  echo "  ${CYAN}fix(navbar): resolve mobile menu issue${NC}"
  echo "  ${CYAN}docs: update README${NC}"
  echo "  ${CYAN}refactor(hooks): simplify useAuth hook${NC}"
  echo ""
  print_error "Your commit message:"
  echo "  ${RED}${subject_line}${NC}"
  echo ""
  exit 1
fi

# Extract type, scope, and subject
if echo "$subject_line" | grep -qE "^($valid_types)\(.+\):"; then
  # Has scope
  type=$(echo "$subject_line" | sed -E "s/^($valid_types)\(.+\):.*/\1/")
  scope=$(echo "$subject_line" | sed -E "s/^$valid_types\((.+)\):.*/\1/")
  subject=$(echo "$subject_line" | sed -E "s/^$valid_types\(.+\): (.+)/\1/")
else
  # No scope
  type=$(echo "$subject_line" | sed -E "s/^($valid_types):.*/\1/")
  scope=""
  subject=$(echo "$subject_line" | sed -E "s/^$valid_types: (.+)/\1/")
fi

# Validate subject line length (recommended: 50 chars, max: 72)
subject_length=${#subject}
if [ "$subject_length" -gt 72 ]; then
  print_warning "Subject line is too long (${subject_length} chars, max 72)"
  print_info "Consider shortening the subject line"
  echo ""
fi

# Check if subject starts with lowercase (recommended but not required)
if echo "$subject" | grep -qE "^[A-Z]"; then
  print_warning "Subject line starts with uppercase (lowercase recommended)"
  print_info "Example: 'add feature' instead of 'Add feature'"
  echo ""
fi

# Check for period at end (not recommended)
if echo "$subject" | grep -qE "\.$"; then
  print_warning "Subject line ends with a period (not recommended)"
  echo ""
fi

print_success "Commit message format is valid"
if [ -n "$scope" ]; then
  print_info "Type: ${CYAN}${type}${NC}, Scope: ${CYAN}${scope}${NC}"
else
  print_info "Type: ${CYAN}${type}${NC}"
fi
