# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Track start time
START_TIME=$(date +%s)

# Function to print colored output
print_info() {
  echo "${BLUE}ℹ${NC} $1"
}

print_success() {
  echo "${GREEN}✅${NC} $1"
}

print_error() {
  echo "${RED}❌${NC} $1" >&2
}

print_warning() {
  echo "${YELLOW}⚠️${NC} $1"
}

# Function to exit on error
exit_on_error() {
  if [ $? -ne 0 ]; then
    print_error "$1"
    exit 1
  fi
}

# Check if this is a merge commit
if [ -n "$GIT_MERGE_AUTOEDIT" ] || [ -n "$GIT_MERGE_MODE" ]; then
  print_info "Merge commit detected, skipping pre-commit checks"
  exit 0
fi

# Check for merge conflicts (only check actual conflict markers, not commented examples)
# Look for conflict markers at the start of lines that are NOT in comments
CONFLICT_FILES=""
for file in $(git diff --cached --name-only --diff-filter=ACM); do
  if [ -f "$file" ]; then
    # Check for conflict markers that are actual conflicts (not in comments or code examples)
    # Pattern: <<<<<<< HEAD or <<<<<<< (7 or more <)
    #          ======= (7 or more =)
    #          >>>>>>> branch-name or >>>>>>> (7 or more >)
    # Must be at start of line (possibly with whitespace) and NOT preceded by #, //, or /*
    if grep -qE '^[[:space:]]*<<<<<<< |^[[:space:]]*=======$|^[[:space:]]*>>>>>>> ' "$file" 2>/dev/null; then
      # Double-check it's not in a comment (for common comment styles)
      if ! grep -qE '^[[:space:]]*#.*<<<<<<|^[[:space:]]*//.*<<<<<<|^[[:space:]]*/\*.*<<<<<<' "$file" 2>/dev/null; then
        CONFLICT_FILES="${CONFLICT_FILES}${file}\n"
      fi
    fi
  fi
done
if [ -n "$CONFLICT_FILES" ]; then
  print_error "Merge conflict markers found in staged files!"
  printf "$CONFLICT_FILES"
  print_info "Please resolve conflicts before committing"
  exit 1
fi

# Check for large files (> 1MB)
LARGE_FILES=""
for file in $(git diff --cached --name-only --diff-filter=ACM); do
  if [ -f "$file" ]; then
    # Get file size (works on both Linux and macOS)
    SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null || echo 0)
    if [ "$SIZE" -gt 1048576 ]; then
      LARGE_FILES="${LARGE_FILES}${file}\n"
    fi
  fi
done
if [ -n "$LARGE_FILES" ]; then
  print_warning "Large files detected (>1MB):"
  printf "$LARGE_FILES"
  print_info "Consider using Git LFS for large files"
  print_warning "Commit will proceed, but consider reviewing large files"
fi

print_info "Running pre-commit checks..."
echo ""

# Check if there are staged files
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)
if [ -z "$STAGED_FILES" ]; then
  print_warning "No staged files to check"
  exit 0
fi

# Check if TypeScript files are staged
HAS_TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)

# Run lint-staged (format and lint)
print_info "Formatting and linting staged files..."
if ! npx lint-staged; then
  print_error "Lint-staged failed!"
  print_info "Fix the errors above and try again"
  exit 1
fi
print_success "Linting and formatting passed"

# Run TypeScript type check (only if TS files are staged)
if [ -n "$HAS_TS_FILES" ]; then
  echo ""
  print_info "Running TypeScript type check..."
  if ! npm run typecheck; then
    print_error "TypeScript type check failed!"
    print_info "Fix the type errors above and try again"
    exit 1
  fi
  print_success "TypeScript type check passed"
else
  print_info "Skipping TypeScript check (no TS files staged)"
fi

# Calculate and display elapsed time
END_TIME=$(date +%s)
ELAPSED=$((END_TIME - START_TIME))

echo ""
print_success "All checks passed! (took ${ELAPSED}s)"
print_info "Proceeding with commit..."